{% extends 'base.html' %}
{% block content %}
{% load static %}
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col mx-auto mb-3">
        <h2>Local Popularity Map</h2>
        <hr />
        <div class="row g-3 align-items-end">
          <div class="col-sm-4">
            <label class="form-label">Base threshold purchase count</label>
            <input id="thresholdInput" type="number" value="0" min="0" class="form-control" />
          </div>
          <div class="col-sm-4">
            <button id="applyFilterBtn" class="btn bg-dark text-white">Apply Filter</button>
          </div>
          <div class="col-sm-4">
            <button id="locateMeBtn" class="btn btn-outline-primary">Show My Location</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-7 mb-3">
        <div id="map" style="height: 460px; border-radius: 6px; overflow: hidden;"></div>
      </div>
      <div class="col-md-5">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Trending Movies in Selected Area</h5>
            <ul id="resultsList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" crossorigin="" />
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin=""></script>

<script>
  const map = L.map('map', { zoomControl: true, minZoom: 2, maxZoom: 19 }).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: {
      polygon: {
        allowIntersection: false,
        showArea: true,
        shapeOptions: { color: '#0d6efd', weight: 2, fillOpacity: 0.2 }
      },
      polyline: false,
      rectangle: false,
      circle: false,
      circlemarker: false,
      marker: false
    },
    edit: {
      featureGroup: drawnItems,
      edit: true,
      remove: true
    }
  });
  map.addControl(drawControl);

  let selectedPolygonLayer = null;
  let myLocation = { marker: null, circle: null };

  map.on(L.Draw.Event.CREATED, function (event) {
    const layer = event.layer;
    // Only keep one selection at a time
    drawnItems.clearLayers();
    drawnItems.addLayer(layer);
    selectedPolygonLayer = layer;
    layer.setStyle({ color: '#198754', weight: 2, fillOpacity: 0.25 });
  });

  map.on(L.Draw.Event.EDITED, function (event) {
    event.layers.eachLayer(layer => selectedPolygonLayer = layer);
  });

  map.on(L.Draw.Event.DELETED, function () {
    selectedPolygonLayer = null;
  });

  const getCookie = name => document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];

  async function fetchAndRender() {
    const threshold = parseInt(document.getElementById('thresholdInput').value) || 0;
    const list = document.getElementById('resultsList');
    if (!list) return;
    
    list.innerHTML = !selectedPolygonLayer 
      ? '<li class="list-group-item">Draw a polygon on the map to select a region.</li>'
      : '';

    if (!selectedPolygonLayer) return;

    const res = await fetch('/movies/api/popular-by-polygon/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') || '' },
      body: JSON.stringify({ geojson: selectedPolygonLayer.toGeoJSON(), threshold })
    });
    
    const data = await res.json();
    list.innerHTML = data.results.length === 0 
      ? '<li class="list-group-item">No movies meet the threshold.</li>'
      : data.results.map(r => 
          `<li class="list-group-item d-flex justify-content-between align-items-center">
            <span>${r.title}</span><span class="badge bg-primary rounded-pill">${r.purchaseCount}</span>
          </li>`
        ).join('');
  }

  document.getElementById('applyFilterBtn').addEventListener('click', fetchAndRender);
  document.getElementById('locateMeBtn').addEventListener('click', () => {
    if (!navigator.geolocation) return alert('Geolocation is not supported by your browser.');
    
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;
      [myLocation.marker, myLocation.circle].forEach(layer => layer && map.removeLayer(layer));
      
      myLocation.marker = L.marker([lat, lng], { title: 'You are here' }).addTo(map);
      myLocation.circle = L.circle([lat, lng], { radius: 20000, color: '#0d6efd', fillOpacity: 0.1 }).addTo(map);
      map.setView([lat, lng], Math.max(map.getZoom(), 5));
    }, () => alert('Unable to retrieve your location.'), 
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  });
</script>
{% endblock content %}